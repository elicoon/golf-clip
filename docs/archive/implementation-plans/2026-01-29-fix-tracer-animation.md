# Fix Tracer Animation Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix the tracer animation so it draws progressively as the video plays, rather than showing the complete trajectory immediately.

**Architecture:** The animation logic exists in TrajectoryEditor.tsx but there's a timing mismatch between trajectory timestamps and video playback time. The fix involves ensuring timestamps are properly aligned and the animation loop correctly calculates progress.

**Tech Stack:** React, TypeScript, Canvas API, requestAnimationFrame

---

## Problem Analysis

The tracer displays as a static complete line instead of animating progressively. After investigation, the root causes are:

1. **Primary Issue**: Race condition between `setTrajectory()` and video seek operation - the animation useEffect might run before the video has finished seeking, causing incorrect `timeRatio` calculation.

2. **Secondary Issue**: Trajectory timestamps may not be properly aligned with video time, causing the animation to calculate incorrect progress.

---

## Implementation Tasks

### Task 1: Add Debug Logging to Trace Timestamp Flow

**Files:**
- Modify: `packages/frontend/src/components/TrajectoryEditor.tsx:334-340`

**Step 1: Add console.log to verify timestamp values**

```typescript
// After line 336, add:
console.log('TrajectoryEditor animation:', {
  videoTime,
  firstPointTime,
  lastPointTime,
  timeRange,
  timeRatio,
  displayProgress,
  pointCount: localPoints.length
})
```

**Step 2: Test and observe values**

Run: `cd packages/frontend && npm run dev`
Expected: Console shows timestamp values during animation - verify if `firstPointTime` aligns with video strike time

**Step 3: Remove debug logging after diagnosis**

Remove the console.log after confirming the issue.

---

### Task 2: Write Backend Test to Verify Timestamp Generation

**Files:**
- Create: `apps/desktop/backend/tests/test_trajectory_timestamps.py`

**Step 1: Write the failing test**

```python
import pytest
from backend.detection.tracker import ConstrainedBallTracker


def test_trajectory_timestamps_are_absolute():
    """Trajectory timestamps should start from strike_time, not 0."""
    tracker = ConstrainedBallTracker()
    strike_time = 18.25

    result = tracker.generate_configured_trajectory(
        origin=(0.5, 0.85),
        target=(0.5, 0.3),
        landing=(0.55, 0.80),
        starting_line="center",
        shot_shape="straight",
        shot_height="medium",
        strike_time=strike_time,
        flight_duration=3.0,
    )

    first = result["points"][0]
    last = result["points"][-1]

    # First timestamp should be at strike_time
    assert abs(first["timestamp"] - strike_time) < 0.001, \
        f"First timestamp {first['timestamp']} should be {strike_time}"

    # Last timestamp should be strike_time + flight_duration
    expected_last = strike_time + 3.0
    assert abs(last["timestamp"] - expected_last) < 0.1, \
        f"Last timestamp {last['timestamp']} should be ~{expected_last}"
```

**Step 2: Run test to verify it passes or fails**

Run: `cd apps/desktop && pytest backend/tests/test_trajectory_timestamps.py -v`
Expected: If test fails, timestamps are 0-based (the bug). If passes, timestamps are correct.

---

### Task 3: Fix Race Condition in ClipReview.tsx

**Files:**
- Modify: `packages/frontend/src/components/ClipReview.tsx:782-818`

**Step 1: Ensure video is seeked BEFORE trajectory is set**

The video seek and trajectory state update might race. Fix by ensuring video seeks first, then trajectory is set, then playback starts.

```typescript
// Lines 782-818, modify to:
eventSource.addEventListener('complete', (e) => {
  if (generationIdRef.current !== currentGenId || !isMountedRef.current) {
    eventSource.close()
    return
  }
  const data = JSON.parse(e.data)

  // STEP 1: First seek video to clip start (before setting trajectory)
  const video = videoRef.current
  if (video && currentShot) {
    video.pause()  // Pause first to prevent mid-seek playback
    video.currentTime = currentShot.clip_start
  }

  // STEP 2: Small delay to ensure seek completes before animation starts
  setTimeout(() => {
    if (!isMountedRef.current) return

    // STEP 3: Now set trajectory (animation will calculate correct timeRatio)
    setTrajectory(data.trajectory)
    setTrajectoryProgress(null)
    setTrajectoryMessage('')
    setReviewStep('reviewing')

    // Capture early detection stats for debug display
    if (data.early_detection_stats) {
      setEarlyDetectionStats(data.early_detection_stats)
    }

    // Store auto-generated params only on first generation
    if (!hasConfiguredTracer) {
      setAutoGeneratedParams({
        height: tracerConfig.height,
        shape: tracerConfig.shape,
        startingLine: tracerConfig.startingLine,
        flightTime: tracerConfig.flightTime,
      })
    }

    // STEP 4: Start playback after trajectory is set
    if (videoRef.current) {
      videoRef.current.play().catch(() => {
        // Autoplay may be blocked by browser policy, ignore error
      })
    }
  }, 50)  // 50ms delay for seek to complete

  eventSource.close()
  eventSourceRef.current = null
})
```

**Step 2: Verify animation starts correctly**

Run: Manual test - generate trajectory, observe animation starts from beginning
Expected: Tracer draws progressively from origin, not static complete line

---

### Task 4: Add Defensive Check in TrajectoryEditor Animation

**Files:**
- Modify: `packages/frontend/src/components/TrajectoryEditor.tsx:337-340`

**Step 1: Add validation to detect 0-based timestamps**

```typescript
// After line 337, add validation:
const timeRange = lastPointTime - firstPointTime

// Detect if timestamps appear to be 0-based (relative) instead of absolute
// This would indicate a backend bug - log warning for debugging
if (firstPointTime < 1.0 && videoTime > 5.0 && localPoints.length > 0) {
  console.warn('TrajectoryEditor: Timestamps appear 0-based, expected absolute. First point time:', firstPointTime, 'Video time:', videoTime)
}

const timeRatio = timeRange > 0
  ? Math.max(0, Math.min(1, (videoTime - firstPointTime) / timeRange))
  : 0
```

**Step 2: Verify warning appears when timestamps are wrong**

If the backend returns 0-based timestamps, this warning will appear in console.

---

### Task 5: Verify Timestamp Preservation in Database Layer

**Files:**
- Modify: `apps/desktop/backend/models/trajectory.py:58-64`

**Step 1: Add logging to verify timestamps are preserved**

```python
# In create_trajectory(), around line 58-64, add:
from loguru import logger

# After normalizing points, log timestamp range
if normalized_points:
    first_ts = normalized_points[0].get("timestamp", 0)
    last_ts = normalized_points[-1].get("timestamp", 0)
    logger.debug(f"Storing trajectory for shot {shot_id}: timestamps [{first_ts:.2f}s - {last_ts:.2f}s], {len(normalized_points)} points")
```

**Step 2: Verify log output shows correct timestamps**

Run: Generate trajectory, check backend logs
Expected: Log shows timestamps starting from strike_time (e.g., 18.25s), not 0

---

### Task 6: Test Animation Timing Logic

**Files:**
- Review: `packages/frontend/src/components/TrajectoryEditor.tsx:165-204`

**Step 1: Verify timeToProgress easing function**

The `timeToProgress()` function (lines 165-204) converts time ratio to display progress. Review to ensure:
- Returns 0 when t <= 0
- Returns 1 when t >= 1
- Smoothly interpolates between

**Step 2: Manual verification**

With debug logging enabled, verify:
- When video is before strike_time: `timeRatio` should be negative or 0
- When video is at strike_time: `timeRatio` should be 0
- When video is at landing_time: `timeRatio` should be 1

---

### Task 7: Run Full Test Suite and Manual Testing

**Step 1: Run backend tests**

```bash
cd /Users/ecoon/golf-clip/apps/desktop
pytest backend/tests/test_trajectory_timestamps.py -v
pytest backend/tests/ -v -k trajectory
```
Expected: All trajectory tests pass

**Step 2: Manual testing checklist**

- [ ] Open app, process a video with detected shots
- [ ] Mark landing point for first shot
- [ ] Wait for trajectory generation to complete
- [ ] Observe: tracer should NOT be visible until video reaches strike time
- [ ] Play video: tracer should animate progressively during ball flight
- [ ] At end of flight: full tracer should be visible
- [ ] Click "Configure & Regenerate" and change shot height to "high"
- [ ] Verify tracer animates correctly with new parameters

**Step 3: Commit changes**

```bash
git add packages/frontend/src/components/ClipReview.tsx
git add packages/frontend/src/components/TrajectoryEditor.tsx
git add apps/desktop/backend/models/trajectory.py
git add apps/desktop/backend/tests/test_trajectory_timestamps.py
git commit -m "fix: tracer animation now draws progressively during playback

- Fix race condition: seek video before setting trajectory state
- Add 50ms delay after seek to ensure video.currentTime is accurate
- Add defensive warning for 0-based timestamps (backend bug detection)
- Add backend logging for timestamp preservation debugging
- Add test to verify trajectory timestamps are absolute

Fixes: Tracer shows static complete line instead of animating"
```

---

## Summary of File Changes

| File | Lines Changed | Description |
|------|---------------|-------------|
| `packages/frontend/src/components/ClipReview.tsx` | ~20 | Fix race condition with video seek timing |
| `packages/frontend/src/components/TrajectoryEditor.tsx` | ~5 | Add defensive timestamp validation |
| `apps/desktop/backend/models/trajectory.py` | ~3 | Add timestamp preservation logging |
| `apps/desktop/backend/tests/test_trajectory_timestamps.py` | ~25 | New test for timestamp validation |

---

## Testing Strategy

1. **Backend Unit Test**: Verify trajectory timestamps are absolute (start from strike_time)
2. **Manual Frontend Test**: Verify animation draws progressively
3. **Edge Cases**: Test with different shot heights, shapes, and flight times
4. **Regression**: Ensure existing functionality still works

**Commands**:
```bash
# Backend tests
cd /Users/ecoon/golf-clip/apps/desktop
pytest backend/tests/test_trajectory_timestamps.py -v

# Frontend dev server
cd /Users/ecoon/golf-clip/packages/frontend && npm run dev

# Backend server
cd /Users/ecoon/golf-clip/apps/desktop && uvicorn backend.main:app --port 8420
```
